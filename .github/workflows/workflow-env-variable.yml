name: File Persistence Across Jobs - Functional

on: [push]

# WORKFLOW LEVEL ENVIRONMENT VARIABLE (The "Syllabus" rule)
# Available to all jobs and steps for shared, static configuration.
env:
  BUILD_FILE_NAME: 'build_report.txt' # Shared configuration: The filename
  REPORT_HEADER: '--- Build Report ---'

jobs:
  # 1. BUILD JOB: Create the file and upload the initial artifact
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Create and Write Initial File Content
        run: |
          # Use ${{ env.VAR }} for initial write
          echo "${{ env.REPORT_HEADER }}" > ${{ env.BUILD_FILE_NAME }}
          echo "Build Start Time: $(date)" >> ${{ env.BUILD_FILE_NAME }}
          echo "File created in the BUILD job." >> ${{ env.BUILD_FILE_NAME }}

      - name: Show Initial File Content
        run: cat ${{ env.BUILD_FILE_NAME }}
        
      - name: Upload Initial Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts # This name is fixed and shared
          path: ${{ env.BUILD_FILE_NAME }} # Uses the global filename

  # 2. TEST JOB: Download, Modify (Override test), Delete old, and Re-upload
  test:
    runs-on: ubuntu-latest
    needs: [build] # Ensures sequence
    
    # JOB LEVEL ENVIRONMENT VARIABLE (Overrides the global REPORT_HEADER for this job)
    # The shell will prioritize this over the workflow-level value.
    env:
      REPORT_HEADER: '*** Test Results ***' 

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: deployment-artifacts
          path: .
          
      - name: Append Test Results (Using Correct Shell Access)
        run: |
          REPORT_PATH=${{ env.BUILD_FILE_NAME }} 
          echo "File Path from Global Env: $REPORT_PATH"
          
          # FIX: Access the overridden variable using $VAR_NAME (shell syntax).
          # This ensures the Job-Level value ('*** Test Results ***') is used.
          echo "$REPORT_HEADER" >> "$REPORT_PATH"
          
          echo "Test Job ran at: $(date)" >> "$REPORT_PATH"
          echo "All tests passed successfully." >> "$REPORT_PATH"

      # FIX for (409) Conflict: Must delete the existing artifact before uploading the new one.
      - name: üóëÔ∏è Delete Previous Artifact
        uses: geekyeggo/delete-artifact@v2 
        with:
          name: deployment-artifacts
          # The token is required for permissions to delete
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Re-upload Updated Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts
          path: ${{ env.BUILD_FILE_NAME }} 

      - name: Show Updated File Content
        run: cat ${{ env.BUILD_FILE_NAME }}

  # 3. DEPLOY JOB: Read the final file content
  deploy:
    runs-on: ubuntu-latest
    needs: [test] # Ensures sequence
    
    steps:
      - name: Download Final Artifact
        uses: actions/download-artifact@v4
        with:
          name: deployment-artifacts
          path: .

      - name: Read and Verify Final Report
        run: |
          REPORT_FILE=${{ env.BUILD_FILE_NAME }} 
          echo "--- Final Deployment Check ---"
          
          # Read the contents of the final file using the environment variable
          echo "Contents of the $REPORT_FILE file:"
          cat "$REPORT_FILE"