name: File Persistence Across Jobs - Functional

on: [push]

# WORKFLOW LEVEL ENVIRONMENT VARIABLE (The "Syllabus" rule)
# Available to all jobs and steps for shared, static configuration.
env:
  BUILD_FILE_NAME: 'build_report.txt' # Shared configuration: The filename
  REPORT_HEADER: '--- Build Report ---'

jobs:
  # 1. BUILD JOB: Create the file and upload the initial artifact
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Create and Write Initial File Content
        run: |
          # Use ${{ env.VAR }} for initial write
          echo "${{ env.REPORT_HEADER }}" > ${{ env.BUILD_FILE_NAME }}
          echo "Build Start Time: $(date)" >> ${{ env.BUILD_FILE_NAME }}
          echo "File created in the BUILD job." >> ${{ env.BUILD_FILE_NAME }}

      - name: Show Initial File Content
        run: cat ${{ env.BUILD_FILE_NAME }}
        
      - name: Upload Initial Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts # This name is fixed and shared
          path: ${{ env.BUILD_FILE_NAME }} # Uses the global filename

  # 2. TEST JOB: Download, Modify, Delete old, and Re-upload
  test:
    runs-on: ubuntu-latest
    needs: [build]
    
    # ğŸ’¡ FIX 1: Add the permissions block to grant the job artifact management rights
    permissions:
      actions: write # Required to delete/manage workflow artifacts
      contents: read # Required to checkout code/read basic information
      
    env:
      REPORT_HEADER: '*** Test Results ***' 

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: deployment-artifacts
          path: .
          
      - name: Append Test Results (Using Correct Shell Access)
        run: |
          REPORT_PATH=${{ env.BUILD_FILE_NAME }} 
          # Access the overridden variable using $VAR_NAME
          echo "$REPORT_HEADER" >> "$REPORT_PATH"
          echo "Test Job ran at: $(date)" >> "$REPORT_PATH"
          echo "All tests passed successfully." >> "$REPORT_PATH"

      # FIX 2: Removed the 'token' input from this step
      - name: ğŸ—‘ï¸ Delete Previous Artifact
        uses: geekyeggo/delete-artifact@v2 
        with:
          name: deployment-artifacts # Still required
          # token: ${{ secrets.GITHUB_TOKEN }} <-- THIS LINE WAS REMOVED
          
      - name: Re-upload Updated Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts
          path: ${{ env.BUILD_FILE_NAME }} 

      - name: Show Updated File Content
        run: cat ${{ env.BUILD_FILE_NAME }}
        

  # 3. DEPLOY JOB: Read the final file content
  deploy:
    runs-on: ubuntu-latest
    needs: [test] # Ensures sequence
    
    steps:
      - name: Download Final Artifact
        uses: actions/download-artifact@v4
        with:
          name: deployment-artifacts
          path: .

      - name: Read and Verify Final Report
        run: |
          REPORT_FILE=${{ env.BUILD_FILE_NAME }} 
          echo "--- Final Deployment Check ---"
          
          # Read the contents of the final file using the environment variable
          echo "Contents of the $REPORT_FILE file:"
          cat "$REPORT_FILE"